<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> CookDoor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css">
  <style>
    body { background: #f8f9fa; }
    .search-box { max-width: 400px; margin: 30px auto 20px; }
    table { background: #fff; }
  </style>
</head>
<body>
  <div class="container-fluid position-relative" style="padding-right:15px; padding-left:15px;">
    <div class="position-absolute top-0 end-0 m-3 d-flex gap-2" style="z-index:10;">
      <button id="addBtn" class="btn btn-success" style="display:none;"><i class="bi bi-plus-circle"></i> Add</button>
      <button id="saveBtn" class="btn btn-primary" style="display:none;"><i class="bi bi-save"></i> Save</button>
      <button id="editBtn" class="btn btn-warning"><i class="bi bi-lock"></i> Login</button>
    </div>
    <div class="search-box d-flex align-items-center justify-content-between">
      <img src="image .png" alt="logo" style="height:48px;width:auto;">
      <input type="text" id="searchInput" class="form-control mx-2" placeholder="... Search by branch name">
      <img src="image .png" alt="logo" style="height:48px;width:auto;">
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-striped text-center w-100" style="margin:0;">
        <thead class="table-dark">
          <tr>
            <th>الفرع</th>
            <th>الاسم</th>
            <th>العنوان</th>
            <th>الرقم</th>
          </tr>
        </thead>
        <tbody id="branchesTable"></tbody>
      </table>
    </div>
    <!-- نافذة تسجيل الدخول -->
    <div id="loginModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:30px 20px;border-radius:10px;min-width:300px;max-width:90vw;box-shadow:0 0 20px #0002;display:flex;flex-direction:column;align-items:center;">
        <h5 class="mb-3">Admin Login</h5>
        <input id="usernameInput" class="form-control mb-2" placeholder="Username" autocomplete="off">
        <input id="passwordInput" class="form-control mb-2" placeholder="Password" type="password" autocomplete="off">
        <div class="d-flex w-100 justify-content-between">
          <button id="loginSubmit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Login</button>
          <button id="loginCancel" class="btn btn-secondary ms-2"><i class="bi bi-x-circle"></i> Cancel</button>
        </div>
        <div id="loginError" class="text-danger mt-2" style="display:none;font-size:0.95em;"></div>
      </div>
    </div>
    <!-- نافذة اختيار الإضافة أو التعديل -->
    <div id="addOrEditModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:25px 20px;border-radius:10px;min-width:300px;max-width:90vw;box-shadow:0 0 20px #0002;display:flex;flex-direction:column;align-items:center;">
        <h5 class="mb-3" id="addOrEditTitle">إضافة</h5>
        <div id="addOrEditOptions" class="mb-3 w-100">
          <!-- سيتم ملء الخيارات ديناميكياً -->
        </div>
        <div class="d-flex w-100 justify-content-between">
          <button id="addOrEditSubmit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Confirm</button>
          <button id="addOrEditCancel" class="btn btn-secondary ms-2"><i class="bi bi-x-circle"></i> Cancel</button>
        </div>
      </div>
    </div>
    <!-- نافذة إدخال اسم الفرع الجديد -->
    <div id="branchNameModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:25px 20px;border-radius:10px;min-width:320px;max-width:90vw;box-shadow:0 0 20px #0002;display:flex;flex-direction:column;align-items:center;">
        <h5 class="mb-3 text-primary">إضافة فرع جديد</h5>
        <input id="branchNameInput" class="form-control mb-2 text-center fw-bold" placeholder="اسم الفرع الجديد" autocomplete="off" style="font-size:1.1em;">
        <div class="d-flex w-100 justify-content-between">
          <button id="branchNameSubmit" class="btn btn-success"><i class="bi bi-check-circle"></i> Confirm</button>
          <button id="branchNameCancel" class="btn btn-secondary ms-2"><i class="bi bi-x-circle"></i> Cancel</button>
        </div>
        <div id="branchNameError" class="text-danger mt-2" style="display:none;font-size:0.95em;"></div>
      </div>
    </div>
  </div>
  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <!-- Firebase Database (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // إعداد الاتصال بـ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBVC4Rp3ukludEKT9Xjk92-o-KxTDJl-T4",
      authDomain: "cook-5375b.firebaseapp.com",
      databaseURL: "https://cook-5375b-default-rtdb.firebaseio.com",
      projectId: "cook-5375b",
      storageBucket: "cook-5375b.appspot.com",
      messagingSenderId: "210777784695",
      appId: "1:210777784695:web:daa85e8e9eff65c0a76172",
      measurementId: "G-DR1SYWR17K"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('branchesTable');
    searchInput.addEventListener('input', function() {
      if (this.value.trim() === '') {
        const rows = table.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
          rows[i].style.display = '';
        }
      } else {
        // تصفية حسب اسم الفرع
        const filter = this.value.trim();
        const rows = Array.from(table.getElementsByTagName('tr'));
        for (let i = 0; i < rows.length; i++) {
          let branchCell = null;
          for (let j = 0; j < rows[i].cells.length; j++) {
            if (rows[i].cells[j].rowSpan === 2) {
              branchCell = rows[i].cells[j];
              break;
            }
          }
          if (branchCell && branchCell.textContent.includes(filter)) {
            rows[i].style.display = '';
            if (rows[i+1]) rows[i+1].style.display = '';
            i++;
          } else if (branchCell) {
            rows[i].style.display = 'none';
            if (rows[i+1]) rows[i+1].style.display = 'none';
            i++;
          } else {
            rows[i].style.display = 'none';
          }
        }
      }
    });

    // منطق التعديل وتسجيل الدخول
    let isAdmin = false;
    const editBtn = document.getElementById('editBtn');
    const loginModal = document.getElementById('loginModal');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginSubmit = document.getElementById('loginSubmit');
    const loginCancel = document.getElementById('loginCancel');
    const loginError = document.getElementById('loginError');
    const addBtn = document.getElementById('addBtn');
    const addOrEditModal = document.getElementById('addOrEditModal');
    const addOrEditTitle = document.getElementById('addOrEditTitle');
    const addOrEditOptions = document.getElementById('addOrEditOptions');
    const addOrEditSubmit = document.getElementById('addOrEditSubmit');
    const addOrEditCancel = document.getElementById('addOrEditCancel');
    let addOrEditCallback = null;
    let addOrEditContext = null;
    const saveBtn = document.getElementById('saveBtn');

    // إظهار زر الإضافة بعد تسجيل الدخول
    function showAddBtn() {
      addBtn.style.display = 'block';
      saveBtn.style.display = 'block';
      refreshTableFromFirebase();
    }
    // إخفاء زر الإضافة عند تسجيل الخروج (لو أضفت ذلك مستقبلاً)
    function hideAddBtn() {
      addBtn.style.display = 'none';
      saveBtn.style.display = 'none';
      refreshTableFromFirebase();
    }

    // عند الضغط على زر Login/Logout
    editBtn.addEventListener('click', function() {
      if (!isAdmin) {
        loginModal.style.display = 'flex';
        usernameInput.value = '';
        passwordInput.value = '';
        loginError.style.display = 'none';
        setTimeout(() => usernameInput.focus(), 100);
      } else {
        // تسجيل الخروج
        isAdmin = false;
        editBtn.innerHTML = '<i class="bi bi-lock"></i> Login';
        hideAddBtn();
      }
    });

    // بعد تسجيل الدخول بنجاح
    loginSubmit.onclick = function() {
      const user = usernameInput.value.trim();
      const pass = passwordInput.value;
      if (user === 'admin' && pass === '0000') {
        isAdmin = true;
        loginModal.style.display = 'none';
        showAddBtn();
        editBtn.innerHTML = '<i class="bi bi-box-arrow-right"></i> Logout';
      } else {
        loginError.textContent = 'Invalid username or password';
        loginError.style.display = 'block';
      }
    };

    // منطق نافذة الإضافة أو التعديل
    function showAddOrEditModal(title, options, callback, context) {
      addOrEditTitle.textContent = title;
      addOrEditOptions.innerHTML = '';
      options.forEach((opt, i) => {
        const div = document.createElement('div');
        div.className = 'form-check';
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.className = 'form-check-input';
        radio.name = 'addOrEditOption';
        radio.id = 'addOrEditOption' + i;
        radio.value = opt.value;
        if (i === 0) radio.checked = true;
        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = radio.id;
        label.innerHTML = opt.label;
        div.appendChild(radio);
        div.appendChild(label);
        addOrEditOptions.appendChild(div);
      });
      addOrEditModal.style.display = 'flex';
      addOrEditCallback = callback;
      addOrEditContext = context;
    }
    addOrEditCancel.onclick = function() {
      addOrEditModal.style.display = 'none';
    };
    addOrEditSubmit.onclick = function() {
      const selected = addOrEditOptions.querySelector('input[name="addOrEditOption"]:checked');
      if (addOrEditCallback) {
        addOrEditCallback(selected.value, addOrEditContext);
      }
      addOrEditModal.style.display = 'none';
    };
    addOrEditModal.addEventListener('click', function(e) {
      if (e.target === addOrEditModal) addOrEditModal.style.display = 'none';
    });

    // نافذة إدخال اسم الفرع الجديد
    const branchNameModal = document.getElementById('branchNameModal');
    const branchNameInput = document.getElementById('branchNameInput');
    const branchNameSubmit = document.getElementById('branchNameSubmit');
    const branchNameCancel = document.getElementById('branchNameCancel');
    const branchNameError = document.getElementById('branchNameError');
    let branchNameCallback = null;
    function showBranchNameModal(callback, placeholderText) {
      branchNameInput.value = '';
      branchNameInput.placeholder = placeholderText || 'اسم الفرع الجديد';
      branchNameError.style.display = 'none';
      branchNameModal.style.display = 'flex';
      setTimeout(() => branchNameInput.focus(), 100);
      branchNameCallback = callback;
    }
    branchNameCancel.onclick = function() {
      branchNameModal.style.display = 'none';
    };
    branchNameSubmit.onclick = function() {
      const name = branchNameInput.value.trim();
      if (!name) {
        branchNameError.textContent = 'يرجى إدخال اسم الفرع';
        branchNameError.style.display = 'block';
        branchNameInput.focus();
        return;
      }
      branchNameModal.style.display = 'none';
      if (branchNameCallback) branchNameCallback(name);
    };
    branchNameInput.onkeydown = function(e) {
      if (e.key === 'Enter') branchNameSubmit.onclick();
    };
    branchNameModal.addEventListener('click', function(e) {
      if (e.target === branchNameModal) branchNameModal.style.display = 'none';
    });

    // منطق زر الإضافة
    addBtn.addEventListener('click', function() {
      showAddOrEditModal('Add', [
        {label: '<i class="bi bi-plus-circle"></i> Add Row', value: 'row'},
        {label: '<i class="bi bi-layout-three-columns"></i> Add Column', value: 'col'}
      ], function(selected) {
        if (selected === 'row') {
          // نافذة إدخال اسم الفرع فقط
          showBranchNameModal(function(branchName) {
            // الصف الأول
            const newRow1 = table.insertRow();
            const branchCell = newRow1.insertCell();
            branchCell.rowSpan = 2;
            branchCell.className = 'text-center align-middle';
            branchCell.textContent = branchName;
            const nameCell1 = newRow1.insertCell();
            nameCell1.className = 'fw-bold text-start';
            nameCell1.innerHTML = '<span class="text-primary">متوقف:</span> <span class="editable-text text-danger"></span>';
            const addressCell1 = newRow1.insertCell();
            addressCell1.rowSpan = 2;
            addressCell1.className = 'text-start align-middle';
            addressCell1.textContent = '';
            const phoneCell1 = newRow1.insertCell();
            phoneCell1.rowSpan = 2;
            phoneCell1.className = 'text-start align-middle';
            phoneCell1.textContent = '';
            // الصف الثاني
            const newRow2 = table.insertRow();
            newRow2.style.borderBottom = '4px solid #000';
            const nameCell2 = newRow2.insertCell();
            nameCell2.className = 'fw-bold text-start';
            nameCell2.innerHTML = '<span class="text-primary">متاح:</span> <span class="editable-text text-success"></span>';
            saveTableToFirebase();
          });
        } else if (selected === 'col') {
          // إضافة عمود جديد
          const headRow = table.parentElement.querySelector('thead tr');
          const th = document.createElement('th');
          th.innerHTML = 'عمود جديد';
          headRow.appendChild(th);
          for (let i = 0; i < table.rows.length; i++) {
            const cell = table.rows[i].insertCell(-1);
            cell.innerHTML = '';
          }
          saveTableToFirebase();
        }
      });
    });

    // عند الضغط مرتين على أي خلية
    table.addEventListener('dblclick', function(e) {
      if (!isAdmin) return;
      const cell = e.target;
      if (cell.tagName === 'TD') {
        triggerCellEdit(cell);
      }
    });

    // منطق التعديل العادي للخلايا
    function triggerCellEdit(cell) {
      if (cell.querySelector('textarea')) return;
      // تحقق إذا كانت الخلية من عمود الاسم (متوقف أو متاح)
      const isStopped = cell.innerHTML.includes('متوقف:');
      const isAvailable = cell.innerHTML.includes('متاح:');
      let prefix = '';
      if (isStopped) prefix = '<span class="text-primary">متوقف:</span> ';
      if (isAvailable) prefix = '<span class="text-primary">متاح:</span> ';
      let editable = '';
      if (prefix) {
        const span = cell.querySelector('.editable-text');
        editable = span ? span.textContent : '';
      } else {
        editable = cell.innerHTML.replace(/<br\s*\/?>/gi, '\n');
      }
      const textarea = document.createElement('textarea');
      textarea.value = editable;
      textarea.className = 'form-control';
      textarea.style.minWidth = '80px';
      textarea.style.minHeight = '40px';
      textarea.style.resize = 'vertical';
      cell.innerHTML = '';
      cell.appendChild(textarea);
      textarea.focus();
      textarea.select();
      textarea.onblur = function() {
        const lines = textarea.value.split('\n');
        if (prefix) {
          cell.innerHTML = `${prefix}<span class=\"editable-text ${isStopped ? 'text-danger' : 'text-success'}\">${lines.map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>')}</span>`;
          cell.className = 'fw-bold text-start';
        } else {
          cell.innerHTML = lines.map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
        }
        if (lastEditedCell) lastEditedCell.classList.remove('table-warning');
        cell.classList.add('table-warning');
        lastEditedCell = cell;
        saveTableToFirebase();
      };
      textarea.onkeydown = function(ev) {
        if (ev.key === 'Escape') {
          if (prefix) {
            cell.innerHTML = `${prefix}<span class=\"editable-text ${isStopped ? 'text-danger' : 'text-success'}\">${editable}</span>`;
            cell.className = 'fw-bold text-start';
          } else {
            cell.innerHTML = editable.split('\n').map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
          }
        }
      };
    }

    // إغلاق النافذة عند الضغط خارجها
    loginModal.addEventListener('click', function(e) {
      if (e.target === loginModal) loginModal.style.display = 'none';
    });

    // عند مسح خانة البحث، إظهار الجدول بالكامل
    searchInput.addEventListener('input', function() {
      if (this.value.trim() === '') {
        const rows = table.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
          rows[i].style.display = '';
        }
      }
    });

    // تفعيل التعديل على رؤوس الأعمدة بعد تسجيل الدخول
    const tableHead = document.querySelector('thead');
    tableHead.addEventListener('dblclick', function(e) {
      if (!isAdmin) return;
      const th = e.target;
      if (th.tagName === 'TH') {
        if (th.querySelector('textarea')) return;
        const oldValue = th.innerHTML.replace(/<br\s*\/?>/gi, '\n');
        const textarea = document.createElement('textarea');
        textarea.value = oldValue;
        textarea.className = 'form-control';
        textarea.style.minWidth = '60px';
        textarea.style.minHeight = '30px';
        textarea.style.resize = 'vertical';
        th.textContent = '';
        th.appendChild(textarea);
        textarea.focus();
        textarea.select();
        textarea.onblur = function() {
          const lines = textarea.value.split('\n');
          th.innerHTML = lines.map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
          th.classList.add('table-warning');
          setTimeout(() => th.classList.remove('table-warning'), 2000);
          saveHeadersToFirebase();
        };
        textarea.onkeydown = function(ev) {
          if (ev.key === 'Escape') {
            th.innerHTML = oldValue.split('\n').map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
          }
        };
      }
    });

    // دالة لإعادة بناء الجدول مع زر الحذف للأدمن
    function renderTable(data) {
      const table = document.getElementById('branchesTable');
      table.innerHTML = '';
      if (!data) return;
      Object.keys(data).forEach(key => {
        const branch = data[key];
        // الصف الأول (متوقف)
        const row1 = document.createElement('tr');
        let deleteBtn = '';
        if (isAdmin) {
          deleteBtn = `<button class="btn btn-sm btn-danger ms-2 delete-branch-btn" data-key="${key}"><i class="bi bi-trash"></i></button>`;
        }
        row1.innerHTML = `
          <td rowspan="2" class="text-center align-middle">${deleteBtn} ${branch.branch}</td>
          <td class="fw-bold text-start"><span class="text-primary">متوقف:</span> <span class="editable-text text-danger">${branch.stopped || ''}</span></td>
          <td rowspan="2" class="text-start align-middle">${branch.address || ''}</td>
          <td rowspan="2" class="text-start align-middle">${branch.phone || ''}</td>
        `;
        table.appendChild(row1);
        // الصف الثاني (متاح)
        const row2 = document.createElement('tr');
        row2.style.borderBottom = '4px solid #000';
        row2.innerHTML = `
          <td class="fw-bold text-start"><span class="text-primary">متاح:</span> <span class="editable-text text-success">${branch.available || ''}</span></td>
        `;
        table.appendChild(row2);
      });
      // إضافة حدث الحذف للأزرار (للأدمن فقط)
      if (isAdmin) {
        const deleteBtns = document.querySelectorAll('.delete-branch-btn');
        deleteBtns.forEach(btn => {
          btn.onclick = function(e) {
            e.stopPropagation();
            const key = btn.getAttribute('data-key');
            if (confirm('Are you sure you want to delete this branch?')) {
              db.ref('branches/' + key).remove();
            }
          };
        });
      }
    }

    // عند تسجيل الدخول أو الخروج، أعد بناء الجدول ليظهر أو يخفي أزرار الحذف
    function refreshTableFromFirebase() {
      db.ref('branches').once('value').then(snapshot => {
        renderTable(snapshot.val());
      });
    }
    // الاستماع للتغييرات (مرة واحدة فقط)
    db.ref('branches').on('value', (snapshot) => {
      renderTable(snapshot.val());
    });

    // دالة لحفظ كل الجدول في Firebase (تستخدم عند أي تعديل)
    function saveTableToFirebase() {
      const table = document.getElementById('branchesTable');
      const rows = table.querySelectorAll('tr');
      const branches = {};
      for (let i = 0; i < rows.length; i += 2) {
        const branchCell = rows[i].querySelector('td');
        const stoppedCell = rows[i].querySelectorAll('td')[1];
        const addressCell = rows[i].querySelectorAll('td')[2];
        const phoneCell = rows[i].querySelectorAll('td')[3];
        const availableCell = rows[i+1].querySelector('td');
        const branchName = branchCell ? branchCell.textContent : '';
        branches['branch_' + i] = {
          branch: branchName,
          stopped: stoppedCell ? stoppedCell.querySelector('.editable-text')?.textContent : '',
          available: availableCell ? availableCell.querySelector('.editable-text')?.textContent : '',
          address: addressCell ? addressCell.textContent : '',
          phone: phoneCell ? phoneCell.textContent : ''
        };
      }
      db.ref('branches').set(branches);
    }

    // --- دعم تزامن رؤوس الأعمدة عبر Firebase ---
    // حفظ رؤوس الأعمدة في Firebase
    function saveHeadersToFirebase() {
      const ths = document.querySelectorAll('thead th');
      const headers = [];
      ths.forEach(th => headers.push(th.innerHTML));
      db.ref('branchesHeaders').set(headers);
    }

    // تحميل رؤوس الأعمدة من Firebase وتحديث الجدول
    function renderHeaders(headers) {
      if (!headers) return;
      const headRow = document.querySelector('thead tr');
      headRow.innerHTML = '';
      headers.forEach(h => {
        const th = document.createElement('th');
        th.innerHTML = h;
        headRow.appendChild(th);
      });
    }

    // الاستماع لتغييرات رؤوس الأعمدة
    db.ref('branchesHeaders').on('value', (snapshot) => {
      renderHeaders(snapshot.val());
    });

    saveBtn.addEventListener('click', function() {
      saveTableToFirebase();
      saveBtn.innerHTML = '<i class="bi bi-save"></i> Saved!';
      setTimeout(() => { saveBtn.innerHTML = '<i class="bi bi-save"></i> Save'; }, 1200);
    });
  </script>
</body>
</html> 
